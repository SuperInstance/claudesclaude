# Director Protocol Task Sandbox
# Minimal container for isolated task execution

FROM node:22-alpine AS sandbox-base

# Minimal system dependencies for task execution
RUN apk add --no-cache \
    git \
    bash \
    curl \
    jq \
    ca-certificates \
    && addgroup -g 1001 -S sandbox \
    && adduser -S sandboxuser -u 1001 -G sandbox

# Create task directories
WORKDIR /task

# Copy minimal Node.js installation
COPY --from=base /usr/local/bin/node /usr/local/bin/node
COPY --from=base /usr/local/lib/node_modules /usr/local/lib/node_modules

# Install sandbox-specific dependencies
RUN npm install --only=production \
    simple-git \
    uuid \
    winston \
    chokidar

# Set up security constraints
RUN echo 'root soft nofile 1024' >> /etc/security/limits.conf \
    && echo 'root hard nofile 1024' >> /etc/security/limits.conf \
    && echo 'sandboxuser soft nofile 512' >> /etc/security/limits.conf \
    && echo 'sandboxuser hard nofile 512' >> /etc/security/limits.conf

# Create security profile
RUN echo '#!/bin/bash' > /usr/local/bin/sandbox-entrypoint \
    && echo 'set -euo pipefail' >> /usr/local/bin/sandbox-entrypoint \
    && echo 'echo "Starting sandbox with PID: $$"' >> /usr/local/bin/sandbox-entrypoint \
    && echo 'cd /task' >> /usr/local/bin/sandbox-entrypoint \
    && echo 'exec "$@"' >> /usr/local/bin/sandbox-entrypoint \
    && chmod +x /usr/local/bin/sandbox-entrypoint

USER sandboxuser

# Health check for sandbox containers
HEALTHCHECK --interval=60s --timeout=10s --start-period=5s --retries=3 \
    CMD pgrep node || exit 1

# Default command (overridden at runtime)
CMD ["/usr/local/bin/sandbox-entrypoint", "node", "--version"]